name: Fetch JSON Data and Support Card Images from Gametora

on:
  schedule:
    - cron: "0 23 * * *" # Daily 23:00 UTC / 07:00 SGT
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js and dependencies
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Fetch manifest and get latest codes
        id: get-codes
        run: |
          # Fetch the manifest
          curl -s -o manifest.json https://gametora.com/data/manifests/umamusume.json
          
          # Extract the specific codes we need
          CHARACTER_CARDS_CODE=$(jq -r '.["character-cards"]' manifest.json)
          SUPPORT_CARDS_CODE=$(jq -r '.["support-cards"]' manifest.json)
          SKILLS_CODE=$(jq -r '.["skills"]' manifest.json)
          GACHA_CHAR_STANDARD_CODE=$(jq -r '.["gacha/char-standard"]' manifest.json)
          GACHA_SPECIAL_CODE=$(jq -r '.["gacha/special"]' manifest.json)
          GACHA_SUPPORT_STANDARD_CODE=$(jq -r '.["gacha/support-standard"]' manifest.json)
          EN_GACHA_CHAR_STANDARD_CODE=$(jq -r '.["en/gacha/char-standard"]' manifest.json)
          EN_GACHA_SPECIAL_CODE=$(jq -r '.["en/gacha/special"]' manifest.json)
          EN_GACHA_SUPPORT_STANDARD_CODE=$(jq -r '.["en/gacha/support-standard"]' manifest.json)
          EN_LAYOUT_DATA_CODE=$(jq -r '.["en/layout_data"]' manifest.json)
          EVENTS_CHAMPIONS_MEETING_CODE=$(jq -r '.["events/champions-meeting"]' manifest.json)
          
          echo "character_cards_code=$CHARACTER_CARDS_CODE" >> $GITHUB_OUTPUT
          echo "support_cards_code=$SUPPORT_CARDS_CODE" >> $GITHUB_OUTPUT
          echo "skills_code=$SKILLS_CODE" >> $GITHUB_OUTPUT
          echo "gacha_char_standard_code=$GACHA_CHAR_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "gacha_special_code=$GACHA_SPECIAL_CODE" >> $GITHUB_OUTPUT
          echo "gacha_support_standard_code=$GACHA_SUPPORT_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "en_gacha_char_standard_code=$EN_GACHA_CHAR_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "en_gacha_special_code=$EN_GACHA_SPECIAL_CODE" >> $GITHUB_OUTPUT
          echo "en_gacha_support_standard_code=$EN_GACHA_SUPPORT_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "en_layout_data_code=$EN_LAYOUT_DATA_CODE" >> $GITHUB_OUTPUT
          echo "events_champions_meeting_code=$EVENTS_CHAMPIONS_MEETING_CODE" >> $GITHUB_OUTPUT
          
          echo "Latest codes:"
          echo "Character Cards: $CHARACTER_CARDS_CODE"
          echo "Support Cards: $SUPPORT_CARDS_CODE"
          echo "Skills: $SKILLS_CODE"
          echo "Gacha Char Standard: $GACHA_CHAR_STANDARD_CODE"
          echo "Gacha Special: $GACHA_SPECIAL_CODE"
          echo "Gacha Support Standard: $GACHA_SUPPORT_STANDARD_CODE"
          echo "EN Gacha Char Standard: $EN_GACHA_CHAR_STANDARD_CODE"
          echo "EN Gacha Special: $EN_GACHA_SPECIAL_CODE"
          echo "EN Gacha Support Standard: $EN_GACHA_SUPPORT_STANDARD_CODE"
          echo "EN Layout Data: $EN_LAYOUT_DATA_CODE"
          echo "Events Champions Meeting: $EVENTS_CHAMPIONS_MEETING_CODE"

      - name: Create data directory
        run: mkdir -p docs/data

      - name: Download JSON files with change detection
        id: download-files
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p docs/data/archive
          
          # Track if any files were added or updated
          FILES_CHANGED=false
          
          # Function to download and check file
          download_and_check() {
            local name=$1
            local url=$2
            local filename="docs/data/${name}.json"
            local temp_file="${filename}.tmp"
            
            echo "ðŸ“¥ Processing $name..."
            
            # Check if file doesn't exist or is empty
            if [ ! -f "$filename" ] || [ ! -s "$filename" ]; then
              echo "ðŸ“­ File $name.json doesn't exist or is empty, downloading..."
              
              # Download to temporary file
              if curl -s -o "$temp_file" "$url"; then
                # Check if file is valid JSON
                if jq empty "$temp_file" 2>/dev/null; then
                  # Move temp file to final location
                  mv "$temp_file" "$filename"
                  echo "âœ… Downloaded new $name.json"
                  FILES_CHANGED=true
                else
                  echo "âŒ $name.json is not valid JSON. Skipping."
                  rm "$temp_file"
                fi
              else
                echo "âŒ Failed to download $name from $url"
              fi
            else
              echo "ðŸ“ File $name.json exists, checking for updates..."
              
              # Download to temporary file for comparison
              if curl -s -o "$temp_file" "$url"; then
                # Check if file is valid JSON
                if jq empty "$temp_file" 2>/dev/null; then
                  # Check if file has changed
                  if cmp -s "$filename" "$temp_file"; then
                    echo "âœ… No changes detected for $name.json, skipping update"
                    rm "$temp_file"
                  else
                    # Archive old file
                    cp "$filename" "docs/data/archive/${name}_${TIMESTAMP}.json"
                    echo "ðŸ“ Archived $name.json to archive/${name}_${TIMESTAMP}.json"
                    
                    # Move temp file to final location
                    mv "$temp_file" "$filename"
                    echo "ðŸ”„ Updated $name.json"
                    FILES_CHANGED=true
                  fi
                else
                  echo "âŒ $name.json is not valid JSON. Skipping update."
                  rm "$temp_file"
                fi
              else
                echo "âŒ Failed to download $name from $url"
              fi
            fi
          }
          
          # Download all files with existence checks and change detection
          download_and_check "character-cards" "https://gametora.com/data/umamusume/character-cards.${{ steps.get-codes.outputs.character_cards_code }}.json"
          download_and_check "support-cards" "https://gametora.com/data/umamusume/support-cards.${{ steps.get-codes.outputs.support_cards_code }}.json"
          download_and_check "skills" "https://gametora.com/data/umamusume/skills.${{ steps.get-codes.outputs.skills_code }}.json"
          download_and_check "gacha-char-standard" "https://gametora.com/data/umamusume/gacha/char-standard.${{ steps.get-codes.outputs.gacha_char_standard_code }}.json"
          download_and_check "gacha-special" "https://gametora.com/data/umamusume/gacha/special.${{ steps.get-codes.outputs.gacha_special_code }}.json"
          download_and_check "gacha-support-standard" "https://gametora.com/data/umamusume/gacha/support-standard.${{ steps.get-codes.outputs.gacha_support_standard_code }}.json"
          download_and_check "en-gacha-char-standard" "https://gametora.com/data/umamusume/en/gacha/char-standard.${{ steps.get-codes.outputs.en_gacha_char_standard_code }}.json"
          download_and_check "en-gacha-special" "https://gametora.com/data/umamusume/en/gacha/special.${{ steps.get-codes.outputs.en_gacha_special_code }}.json"
          download_and_check "en-gacha-support-standard" "https://gametora.com/data/umamusume/en/gacha/support-standard.${{ steps.get-codes.outputs.en_gacha_support_standard_code }}.json"
          download_and_check "en-layout-data" "https://gametora.com/data/umamusume/en/layout_data.${{ steps.get-codes.outputs.en_layout_data_code }}.json"
          download_and_check "events-champions-meeting" "https://gametora.com/data/umamusume/events/champions-meeting.${{ steps.get-codes.outputs.events_champions_meeting_code }}.json"
          
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

      - name: List downloaded files
        run: |
          echo "ðŸ“‚ Current files in docs/data/:"
          ls -la docs/data/
          echo ""
          echo "ðŸ“ Files in archive directory:"
          ls -la docs/data/archive/ || echo "No archive directory"

      - name: Commit and push JSON changes
        if: steps.download-files.outputs.files_changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update JSON data from Gametora API [$(date +%Y-%m-%d)]"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          branch: main
          file_pattern: "docs/data/**"
          add_options: "-A"

  download-support-images:
    needs: update-json
    runs-on: ubuntu-latest
    if: always() # Run even if update-json fails
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Create images directory
        run: mkdir -p docs/images/support-cards

      - name: Extract support IDs and download images
        id: download-images
        run: |
          SUPPORT_JSON="docs/data/support-cards.json"
          IMAGE_DIR="docs/images/support-cards"
          
          # Check if support-cards.json exists
          if [ ! -f "$SUPPORT_JSON" ]; then
            echo "âŒ support-cards.json not found at $SUPPORT_JSON"
            exit 1
          fi
          
          echo "ðŸ“– Reading support IDs from $SUPPORT_JSON..."
          
          # Extract all support_id values and download images
          IMAGES_DOWNLOADED=0
          IMAGES_SKIPPED=0
          IMAGES_FAILED=0
          
          # Get all support_id values from the JSON
          SUPPORT_IDS=$(jq -r '.[] | .support_id' "$SUPPORT_JSON")
          
          echo "ðŸ” Found $(echo "$SUPPORT_IDS" | wc -l) support IDs to process"
          
          for SUPPORT_ID in $SUPPORT_IDS; do
            # Skip if support_id is null or empty
            if [ "$SUPPORT_ID" = "null" ] || [ -z "$SUPPORT_ID" ]; then
              continue
            fi
            
            # Format the ID to 5 digits with leading zeros
            FORMATTED_ID=$(printf "%05d" "$SUPPORT_ID")
            IMAGE_URL="https://gametora.com/images/umamusume/supports/support_card_s_${FORMATTED_ID}.png"
            IMAGE_PATH="${IMAGE_DIR}/support_card_s_${FORMATTED_ID}.png"
            
            # Check if image already exists
            if [ -f "$IMAGE_PATH" ]; then
              echo "âœ… Image already exists: support_card_s_${FORMATTED_ID}.png"
              IMAGES_SKIPPED=$((IMAGES_SKIPPED + 1))
            else
              echo "ðŸ“¥ Downloading: $IMAGE_URL"
              
              # Download the image with error handling
              if curl -s -f -o "$IMAGE_PATH" "$IMAGE_URL"; then
                # Verify the downloaded file is not empty and is a valid image
                if [ -s "$IMAGE_PATH" ] && file "$IMAGE_PATH" | grep -q "PNG image data"; then
                  echo "âœ… Successfully downloaded: support_card_s_${FORMATTED_ID}.png"
                  IMAGES_DOWNLOADED=$((IMAGES_DOWNLOADED + 1))
                else
                  echo "âŒ Downloaded file is not a valid PNG: support_card_s_${FORMATTED_ID}.png"
                  rm -f "$IMAGE_PATH"
                  IMAGES_FAILED=$((IMAGES_FAILED + 1))
                fi
              else
                echo "âŒ Failed to download: support_card_s_${FORMATTED_ID}.png"
                # Remove empty file if created
                rm -f "$IMAGE_PATH"
                IMAGES_FAILED=$((IMAGES_FAILED + 1))
              fi
              
              # Add a small delay to be respectful to the server
              sleep 0.1
            fi
          done
          
          echo "ðŸ“Š Download Summary:"
          echo "   Downloaded: $IMAGES_DOWNLOADED"
          echo "   Skipped (already exist): $IMAGES_SKIPPED"
          echo "   Failed: $IMAGES_FAILED"
          
          echo "images_downloaded=$IMAGES_DOWNLOADED" >> $GITHUB_OUTPUT
          echo "images_skipped=$IMAGES_SKIPPED" >> $GITHUB_OUTPUT
          echo "images_failed=$IMAGES_FAILED" >> $GITHUB_OUTPUT

      - name: List downloaded images
        run: |
          echo "ðŸ“‚ Images in docs/images/support-cards/:"
          ls -la docs/images/support-cards/ | head -20
          echo "Total files: $(ls -1 docs/images/support-cards/ | wc -l)"

      - name: Commit and push image changes
        if: steps.download-images.outputs.images_downloaded > 0
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Add support card images [$(date +%Y-%m-%d)] - Downloaded ${{ steps.download-images.outputs.images_downloaded }} new images"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          branch: main
          file_pattern: "docs/images/support-cards/**"
          add_options: "-A"