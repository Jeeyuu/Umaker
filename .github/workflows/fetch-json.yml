name: Fetch JSON Data and Images from Gametora

on:
  schedule:
    - cron: "0 23 * * *" # Daily 23:00 UTC / 07:00 SGT
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js and dependencies
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Fetch manifest and get latest codes
        id: get-codes
        run: |
          curl -s -o manifest.json https://gametora.com/data/manifests/umamusume.json
          
          CHARACTER_CARDS_CODE=$(jq -r '.["character-cards"]' manifest.json)
          SUPPORT_CARDS_CODE=$(jq -r '.["support-cards"]' manifest.json)
          SKILLS_CODE=$(jq -r '.["skills"]' manifest.json)
          GACHA_CHAR_STANDARD_CODE=$(jq -r '.["gacha/char-standard"]' manifest.json)
          GACHA_SPECIAL_CODE=$(jq -r '.["gacha/special"]' manifest.json)
          GACHA_SUPPORT_STANDARD_CODE=$(jq -r '.["gacha/support-standard"]' manifest.json)
          EN_GACHA_CHAR_STANDARD_CODE=$(jq -r '.["en/gacha/char-standard"]' manifest.json)
          EN_GACHA_SPECIAL_CODE=$(jq -r '.["en/gacha/special"]' manifest.json)
          EN_GACHA_SUPPORT_STANDARD_CODE=$(jq -r '.["en/gacha/support-standard"]' manifest.json)
          EN_LAYOUT_DATA_CODE=$(jq -r '.["en/layout_data"]' manifest.json)
          EVENTS_CHAMPIONS_MEETING_CODE=$(jq -r '.["events/champions-meeting"]' manifest.json)
          
          echo "character_cards_code=$CHARACTER_CARDS_CODE" >> $GITHUB_OUTPUT
          echo "support_cards_code=$SUPPORT_CARDS_CODE" >> $GITHUB_OUTPUT
          echo "skills_code=$SKILLS_CODE" >> $GITHUB_OUTPUT
          echo "gacha_char_standard_code=$GACHA_CHAR_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "gacha_special_code=$GACHA_SPECIAL_CODE" >> $GITHUB_OUTPUT
          echo "gacha_support_standard_code=$GACHA_SUPPORT_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "en_gacha_char_standard_code=$EN_GACHA_CHAR_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "en_gacha_special_code=$EN_GACHA_SPECIAL_CODE" >> $GITHUB_OUTPUT
          echo "en_gacha_support_standard_code=$EN_GACHA_SUPPORT_STANDARD_CODE" >> $GITHUB_OUTPUT
          echo "en_layout_data_code=$EN_LAYOUT_DATA_CODE" >> $GITHUB_OUTPUT
          echo "events_champions_meeting_code=$EVENTS_CHAMPIONS_MEETING_CODE" >> $GITHUB_OUTPUT

      - name: Create data directory
        run: mkdir -p docs/data

      - name: Download JSON files with change detection
        id: download-files
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p docs/data/archive
          
          FILES_CHANGED=false
          
          download_and_check() {
            local name=$1
            local url=$2
            local filename="docs/data/${name}.json"
            local temp_file="${filename}.tmp"
            
            echo "Processing $name..."
            
            if [ ! -f "$filename" ] || [ ! -s "$filename" ]; then
              echo "File $name.json doesn't exist or is empty, downloading..."
              
              if curl -s -o "$temp_file" "$url"; then
                if jq empty "$temp_file" 2>/dev/null; then
                  mv "$temp_file" "$filename"
                  echo "Downloaded new $name.json"
                  FILES_CHANGED=true
                else
                  echo "$name.json is not valid JSON. Skipping."
                  rm "$temp_file"
                fi
              else
                echo "Failed to download $name from $url"
              fi
            else
              echo "File $name.json exists, checking for updates..."
              
              if curl -s -o "$temp_file" "$url"; then
                if jq empty "$temp_file" 2>/dev/null; then
                  if cmp -s "$filename" "$temp_file"; then
                    echo "No changes detected for $name.json, skipping update"
                    rm "$temp_file"
                  else
                    cp "$filename" "docs/data/archive/${name}_${TIMESTAMP}.json"
                    echo "Archived $name.json to archive/${name}_${TIMESTAMP}.json"
                    mv "$temp_file" "$filename"
                    echo "Updated $name.json"
                    FILES_CHANGED=true
                  fi
                else
                  echo "$name.json is not valid JSON. Skipping update."
                  rm "$temp_file"
                fi
              else
                echo "Failed to download $name from $url"
              fi
            fi
          }
          
          download_and_check "character-cards" "https://gametora.com/data/umamusume/character-cards.${{ steps.get-codes.outputs.character_cards_code }}.json"
          download_and_check "support-cards" "https://gametora.com/data/umamusume/support-cards.${{ steps.get-codes.outputs.support_cards_code }}.json"
          download_and_check "skills" "https://gametora.com/data/umamusume/skills.${{ steps.get-codes.outputs.skills_code }}.json"
          download_and_check "gacha-char-standard" "https://gametora.com/data/umamusume/gacha/char-standard.${{ steps.get-codes.outputs.gacha_char_standard_code }}.json"
          download_and_check "gacha-special" "https://gametora.com/data/umamusume/gacha/special.${{ steps.get-codes.outputs.gacha_special_code }}.json"
          download_and_check "gacha-support-standard" "https://gametora.com/data/umamusume/gacha/support-standard.${{ steps.get-codes.outputs.gacha_support_standard_code }}.json"
          download_and_check "en-gacha-char-standard" "https://gametora.com/data/umamusume/en/gacha/char-standard.${{ steps.get-codes.outputs.en_gacha_char_standard_code }}.json"
          download_and_check "en-gacha-special" "https://gametora.com/data/umamusume/en/gacha/special.${{ steps.get-codes.outputs.en_gacha_special_code }}.json"
          download_and_check "en-gacha-support-standard" "https://gametora.com/data/umamusume/en/gacha/support-standard.${{ steps.get-codes.outputs.en_gacha_support_standard_code }}.json"
          download_and_check "en-layout-data" "https://gametora.com/data/umamusume/en/layout_data.${{ steps.get-codes.outputs.en_layout_data_code }}.json"
          download_and_check "events-champions-meeting" "https://gametora.com/data/umamusume/events/champions-meeting.${{ steps.get-codes.outputs.events_champions_meeting_code }}.json"
          
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

      - name: Commit and push JSON changes
        if: steps.download-files.outputs.files_changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update JSON data from Gametora API [$(date +%Y-%m-%d)]"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          branch: main
          file_pattern: "docs/data/**"
          add_options: "-A"

  download-support-images:
    needs: update-json
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl file

      - name: Create images directory
        run: mkdir -p docs/images/support_card_s

      - name: Download missing support card images
        id: download-images
        run: |
          SUPPORT_JSON="docs/data/support-cards.json"
          IMAGE_DIR="docs/images/support_card_s"
          
          if [ ! -f "$SUPPORT_JSON" ]; then
            echo "support-cards.json not found at $SUPPORT_JSON"
            exit 1
          fi
          
          echo "Reading support IDs from $SUPPORT_JSON"
          
          EXISTING_IMAGES=$(find "$IMAGE_DIR" -name "support_card_s_*.png" -type f | sed 's/.*support_card_s_//; s/\.png//' | sort -n)
          echo "Found $(echo "$EXISTING_IMAGES" | wc -l) existing images"
          
          ALL_SUPPORT_IDS=$(jq -r '.[] | .support_id' "$SUPPORT_JSON" | sort -n | uniq)
          echo "Found $(echo "$ALL_SUPPORT_IDS" | wc -l) support IDs in JSON"
          
          MISSING_IDS=$(comm -23 <(echo "$ALL_SUPPORT_IDS") <(echo "$EXISTING_IMAGES") | grep -v '^null$' | grep -v '^$')
          
          MISSING_COUNT=$(echo "$MISSING_IDS" | wc -l)
          echo "Found $MISSING_COUNT missing images to download"
          
          if [ "$MISSING_COUNT" -eq 0 ]; then
            echo "All images are already downloaded. No work to do."
            echo "images_downloaded=0" >> $GITHUB_OUTPUT
            echo "images_failed=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          IMAGES_DOWNLOADED=0
          IMAGES_FAILED=0
          
          echo "Starting download of $MISSING_COUNT missing images"
          
          for SUPPORT_ID in $MISSING_IDS; do
            FORMATTED_ID=$(printf "%05d" "$SUPPORT_ID")
            IMAGE_URL="https://gametora.com/images/umamusume/supports/support_card_s_${FORMATTED_ID}.png"
            IMAGE_PATH="${IMAGE_DIR}/support_card_s_${FORMATTED_ID}.png"
            
            echo "Downloading: $IMAGE_URL"
            
            if curl -s -f -o "$IMAGE_PATH" "$IMAGE_URL"; then
              if [ -s "$IMAGE_PATH" ] && file "$IMAGE_PATH" | grep -q "PNG image data"; then
                echo "Successfully downloaded: support_card_s_${FORMATTED_ID}.png"
                IMAGES_DOWNLOADED=$((IMAGES_DOWNLOADED + 1))
              else
                echo "Downloaded file is not a valid PNG: support_card_s_${FORMATTED_ID}.png"
                rm -f "$IMAGE_PATH"
                IMAGES_FAILED=$((IMAGES_FAILED + 1))
              fi
            else
              echo "Failed to download: support_card_s_${FORMATTED_ID}.png"
              rm -f "$IMAGE_PATH"
              IMAGES_FAILED=$((IMAGES_FAILED + 1))
            fi
            
            sleep 0.2
          done
          
          echo "Download Summary:"
          echo "  Downloaded: $IMAGES_DOWNLOADED"
          echo "  Failed: $IMAGES_FAILED"
          echo "  Total missing found: $MISSING_COUNT"
          
          echo "images_downloaded=$IMAGES_DOWNLOADED" >> $GITHUB_OUTPUT
          echo "images_failed=$IMAGES_FAILED" >> $GITHUB_OUTPUT

      - name: Commit and push image changes
        if: ${{ steps.download-images.outputs.images_downloaded > 0 }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Add ${{ steps.download-images.outputs.images_downloaded }} new support card images [$(date +%Y-%m-%d)]"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          branch: main
          file_pattern: "docs/images/support_card_s/**"
          add_options: "-A"

  download-character-images:
    needs: update-json
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl file

      - name: Create images directory
        run: mkdir -p docs/images/chara_stand

      - name: Debug character JSON structure
        run: |
          echo "First character entry in JSON:"
          jq '.[0]' docs/data/character-cards.json
          echo "First 5 character entries with IDs:"
          jq -r '.[0:5] | .[] | "char_id: \(.char_id), card_id: \(.card_id), costume: \(.costume)"' docs/data/character-cards.json

      - name: Download missing character images
        id: download-character-images
        run: |
          CHARACTER_JSON="docs/data/character-cards.json"
          IMAGE_DIR="docs/images/chara_stand"
          
          if [ ! -f "$CHARACTER_JSON" ]; then
            echo "character-cards.json not found at $CHARACTER_JSON"
            exit 1
          fi
          
          echo "Reading character data from $CHARACTER_JSON"
          
          # Get existing character images
          EXISTING_IMAGES=$(find "$IMAGE_DIR" -name "chara_stand_*.png" -type f | sed 's/.*chara_stand_//; s/\.png//' | sort -n)
          echo "Found $(echo "$EXISTING_IMAGES" | wc -l) existing character images"
          
          # FIXED: Use card_id instead of costume
          ALL_CHARACTER_IMAGES=$(jq -r '.[] | "\(.char_id)_\(.card_id)"' "$CHARACTER_JSON" | sort -n | uniq)
          echo "Found $(echo "$ALL_CHARACTER_IMAGES" | wc -l) character images in JSON"
          
          # Find missing images
          MISSING_IMAGES=$(comm -23 <(echo "$ALL_CHARACTER_IMAGES") <(echo "$EXISTING_IMAGES") | grep -v '^null_' | grep -v '^$')
          
          MISSING_COUNT=$(echo "$MISSING_IMAGES" | wc -l)
          echo "Found $MISSING_COUNT missing character images to download"
          
          if [ "$MISSING_COUNT" -eq 0 ]; then
            echo "All character images are already downloaded. No work to do."
            echo "char_images_downloaded=0" >> $GITHUB_OUTPUT
            echo "char_images_failed=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CHAR_IMAGES_DOWNLOADED=0
          CHAR_IMAGES_FAILED=0
          
          echo "Starting download of $MISSING_COUNT missing character images"
          
          for CHAR_DATA in $MISSING_IMAGES; do
            CHAR_ID=$(echo "$CHAR_DATA" | cut -d'_' -f1)
            CARD_ID=$(echo "$CHAR_DATA" | cut -d'_' -f2)
            
            IMAGE_URL="https://gametora.com/images/umamusume/characters/thumb/chara_stand_${CHAR_ID}_${CARD_ID}.png"
            IMAGE_PATH="${IMAGE_DIR}/chara_stand_${CHAR_ID}_${CARD_ID}.png"
            
            echo "Downloading: $IMAGE_URL"
            
            if curl -s -f -o "$IMAGE_PATH" "$IMAGE_URL"; then
              if [ -s "$IMAGE_PATH" ] && file "$IMAGE_PATH" | grep -q "PNG image data"; then
                echo "Successfully downloaded: chara_stand_${CHAR_ID}_${CARD_ID}.png"
                CHAR_IMAGES_DOWNLOADED=$((CHAR_IMAGES_DOWNLOADED + 1))
              else
                echo "Downloaded file is not a valid PNG: chara_stand_${CHAR_ID}_${CARD_ID}.png"
                rm -f "$IMAGE_PATH"
                CHAR_IMAGES_FAILED=$((CHAR_IMAGES_FAILED + 1))
              fi
            else
              echo "Failed to download: chara_stand_${CHAR_ID}_${CARD_ID}.png"
              rm -f "$IMAGE_PATH"
              CHAR_IMAGES_FAILED=$((CHAR_IMAGES_FAILED + 1))
            fi
            
            sleep 0.2
          done
          
          echo "Character Image Download Summary:"
          echo "  Downloaded: $CHAR_IMAGES_DOWNLOADED"
          echo "  Failed: $CHAR_IMAGES_FAILED"
          echo "  Total missing found: $MISSING_COUNT"
          
          echo "char_images_downloaded=$CHAR_IMAGES_DOWNLOADED" >> $GITHUB_OUTPUT
          echo "char_images_failed=$CHAR_IMAGES_FAILED" >> $GITHUB_OUTPUT

      - name: Commit and push character image changes
        if: ${{ steps.download-character-images.outputs.char_images_downloaded > 0 }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Add ${{ steps.download-character-images.outputs.char_images_downloaded }} new character images [$(date +%Y-%m-%d)]"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          branch: main
          file_pattern: "docs/images/chara_stand/**"
          add_options: "-A"